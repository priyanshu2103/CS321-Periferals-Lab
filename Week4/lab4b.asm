cpu "8085.tbl"
hof "int8"

org 9000h

GTHEX: EQU 030EH				;Gets hex digits and stores them in DE register pair
CLEAR: EQU 02BEH			;Clears the display
MVI A,8BH
OUT 43H
;INITIAL FLOOR

CALL GTHEX
MOV A,E
STA 8800H
STA 8810H                          ;pROBABLE eRROR

MVI A,01H
STA 8801H

LDA 8810H
MOV C,A

L30:
LDA 8801H
RLC
STA 8801H
DCR C
JNZ L30

CALL CLEAR
GROUND:

MVI A,01H
OUT 40H

MVI A,00H
STA 8000H


IN 41H
MOV B,A
MVI C,01H
MVI D,08H

LOOP:
DCR D
MOV A,D
CPI 00H
JZ GROUND

MOV A,C
RRC
MOV C,A
MOV A,B
ANA C
JZ LOOP

MOV A,C
STA 8001H         ;8001 STORES HIGHEST FLOOR (POW(2,FLOOR))

MOV A,D 
STA 8000H		 ; 8000 STORES HIGHEST FLOOR

;MOVE UP
MVI A,01H
STA 8001H

INR D

MVI A,00H
STA 8002H

UP:
LDA 8001H
OUT 40H

IN 41H
MOV B,A
LDA 8801H
ANA B
JNZ BOSS

LDA 8001H
RLC 
STA 8001H
CALL DELAY

LDA 8002H
INR A
STA 8002H

DCR D
JNZ UP


LDA 8001H
RRC
STA 8001H

DOWN:

LDA 8001H
OUT 40H

IN 41H
MOV B,A
LDA 8801H
ANA B
JNZ BOSS

LDA 8001H
MOV B,A
CALL DELAY

IN 41H
ANA B
JZ L2
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
L2:

LDA 8001H
RRC
STA 8001H

LDA 8000H
DCR A
STA 8000H

CPI 00H
JNZ DOWN
MVI A,01H
OUT 40H
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY

JMP GROUND

DELAY: 							;delays machine by 1 second
	MVI C,03H
OUTLOOP:
	LXI H,0A604H
INLOOP: 						;reapeatedly run inloop as many times as
	DCX H 						;frequency of microprocessor
	MOV A,H
	ORA L
	JNZ INLOOP
	DCR C
	JNZ OUTLOOP
	RET

RST 5

; CALL THIS BEFORE CALLING DELAY AT EACH BEEP
BOSS:
	
	LDA 8002H   ; CURRENT FLOOR
	MOV B,A 
	LDA 8800H   ; BOSS
	CMP B
	JZ L7

	JC L8  
	;MVI A, 0FFH
	;OUT 40H
	;CALL DELAY
	;CALL DELAY
	;RST 5
	   
;UP
	L9:
	


	LDA 8002H
	INR A
	STA 8002H
	LDA 8001H
	RLC 
	OUT 40H
	STA 8001H
	CALL DELAY

	;MVI A, 0FFH
	;OUT 40H
	;CALL DELAY
	
	LDA 8002H
	MOV B,A
	LDA 8800H

	CMP B
	JNZ L9

	;MVI A, 0FH
	;OUT 40H
	;CALL DELAY

	L7:
	CALL DELAY
	CALL DELAY
	CALL DELAY
	CALL DELAY

;DOWN
	L8:

	LDA 8001H
	RRC
	STA 8001H

	LDA 8001H
	OUT 40H
	CALL DELAY

	LDA 8001H
	MOV B,A
	LDA 8801H
	CMP B
	JZ L7
	LDA 8001H
	CPI 01H
	JNZ L8
	JZ L10

	;LDA 8800H
	;MOV B,A

	;MOV A,D
	;CMP B
	;JZ L7

	;JMP L8

	L10:
	MVI A,01H
	OUT 40H
	CALL DELAY
	CALL DELAY
	CALL DELAY
	CALL DELAY

	JMP GROUND
